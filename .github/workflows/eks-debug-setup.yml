name: Zero Touch – Deploy & Verify

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy-and-verify:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-south-1
      CLUSTER_NAME: zero-touch-cluster
      APP_NAME: ${{ github.event.repository.name }}

    steps:
    # -------------------------------------------------
    # 1️⃣ Checkout
    # -------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------
    # 2️⃣ AWS Auth (OIDC)
    # -------------------------------------------------
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ap-south-1

    # -------------------------------------------------
    # 3️⃣ Configure kubectl
    # -------------------------------------------------
    - name: Configure kubectl
      run: |
        aws eks update-kubeconfig \
          --name $CLUSTER_NAME \
          --region $AWS_REGION

        kubectl version --client
        kubectl cluster-info

    # -------------------------------------------------
    # 4️⃣ Verify Nodes (CRITICAL)
    # -------------------------------------------------
    - name: Verify EKS Nodes
      run: |
        echo "Checking nodes..."
        kubectl get nodes

        NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
        if [ "$NODE_COUNT" -eq 0 ]; then
          echo "❌ No nodes found in cluster"
          exit 1
        fi

        echo "✅ Nodes are present"

    # -------------------------------------------------
    # 5️⃣ Verify Pods
    # -------------------------------------------------
    - name: Verify Application Pods
      run: |
        kubectl get pods

        NOT_RUNNING=$(kubectl get pods --no-headers | awk '$3 != "Running" {print}')
        if [ -n "$NOT_RUNNING" ]; then
          echo "❌ Some pods are not running:"
          echo "$NOT_RUNNING"
          exit 1
        fi

        echo "✅ All pods are running"

    # -------------------------------------------------
    # 6️⃣ Verify Service
    # -------------------------------------------------
    - name: Verify Service
      run: |
        kubectl get svc

        if ! kubectl get svc app-service > /dev/null 2>&1; then
          echo "❌ app-service not found"
          exit 1
        fi

        echo "✅ app-service exists"

    # -------------------------------------------------
    # 7️⃣ Verify Ingress
    # -------------------------------------------------
    - name: Verify Ingress
      run: |
        kubectl get ingress

        if ! kubectl get ingress app-ingress > /dev/null 2>&1; then
          echo "❌ app-ingress not found"
          exit 1
        fi

        echo "✅ Ingress exists"

    # -------------------------------------------------
    # 8️⃣ Verify ALB Address Assigned
    # -------------------------------------------------
    - name: Verify ALB Address
      run: |
        echo "Waiting for ALB address..."

        for i in {1..12}; do
          ADDRESS=$(kubectl get ingress app-ingress -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          if [ -n "$ADDRESS" ]; then
            echo "✅ ALB Address assigned:"
            echo "$ADDRESS"
            exit 0
          fi
          echo "⏳ ALB not ready yet, retrying..."
          sleep 15
        done

        echo "❌ ALB address was not assigned within time"
        exit 1
